# Embarcadero Configuration File
# This file contains all configurable parameters for the Embarcadero distributed message broker

embarcadero:
  # Version information
  version:
    major: 1
    minor: 0

  # Broker settings
  broker:
    port: 1214                    # Main broker port
    broker_port: 12140           # Alternative broker port
    heartbeat_interval: 3        # Heartbeat interval in seconds
    max_brokers: 5               # 1 head + 4 ingestion brokers
    cgroup_core: 85              # CPU core for cgroup assignment

  # CXL memory configuration
  cxl:
    size: 68719476736            # CXL memory size (64GB)
    emulation_size: 34359738368  # CXL emulation memory size (32GB)
    device_path: "/dev/dax0.0"   # CXL device path
    numa_node: 2                 # NUMA node for CXL memory

  # Storage configuration
  storage:
    segment_size: 4294967296      # Segment size (4GB) to ensure >=1 segment per broker
    # WORKAROUND: 10MB ring to prevent wrap-around when many batches are deferred due to
    # out-of-order arrival. With ORDER=5 FIFO validation, batches arriving out of order
    # are deferred in skipped_batches_5_, and if the ring wraps before they're processed,
    # their headers get overwritten, causing ACK stall at ~37%.
    # 10MB = 81,920 slots/broker; 10GB ~1,359 batches/broker â†’ plenty of headroom.
    batch_headers_size: 10485760  # 10MB (was 1MB)
    batch_size: 2097152          # PERF TUNED: 2MB batch size - balances memory usage with network efficiency (~512 messages/batch)
                              # Works optimally with 256MB buffers (128 batches per buffer before wrapping)
    num_disks: 2                 # Number of disks for storage
    max_topics: 32               # Maximum number of topics
    topic_name_size: 31          # Maximum topic name length
    use_new_bmeta: true          # Enable dual-write to BrokerMetadata (Bmeta)
                              # Set to false to disable dual-write pattern during migration testing

  # Network configuration
  network:
    io_threads: 12               # UPDATED: Right-sized to match client connections (4 pub + 3 sub per broker + overhead)
    disk_io_threads: 4           # Number of disk IO threads
    sub_connections: 3           # Set to 3 connections per broker as requested
    zero_copy_send_limit: 65536     # PERF TUNED: 64KB threshold - optimal for MSG_ZEROCOPY (Linux kernel sweet spot, works with 2MB batches)

    # Publish receive path: default = blocking recv() directly to BLog (CXL), no staging.
    # PERF: use_nonblocking=false gives blocking recv into CXL (11GB/s in 51ddb5b); true = epoll path (regressed).
    use_nonblocking: false      # false = blocking recv direct to CXL (default); true = epoll + optional staging
    # Following settings only used when use_nonblocking=true
    staging_pool_buffer_size_mb: 4
    staging_pool_num_buffers: 128
    num_publish_receive_threads: 8
    num_cxl_allocation_workers: 4
    recv_direct_to_cxl: false
    # PBR backpressure: stop reading TCP when ring above high %, resume when below low %.
    # pbr_high_watermark_pct: 80
    # pbr_low_watermark_pct: 50
    # Pipeline profile (DrainPayloadToBuffer, etc.). Set false for peak bandwidth benchmarks (removes timing overhead).
    enable_publish_pipeline_profile: false

  # Corfu sequencer configuration
  corfu:
    sequencer_port: 50052        # Corfu sequencer port
    replication_port: 50053      # Corfu replication port

  # Scalog sequencer configuration
  scalog:
    sequencer_port: 50051        # Scalog sequencer port
    replication_port: 50052      # Scalog replication port
    sequencer_ip: "192.168.60.173"  # Scalog sequencer IP address
    local_cut_interval: 100      # Scalog local cut interval

  # Platform detection
  platform:
    is_intel: false              # Intel platform flag
    is_amd: false                # AMD platform flag
